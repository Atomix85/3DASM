     1                                  ; external functions from X11 library
     2                                  extern XOpenDisplay
     3                                  extern XDisplayName
     4                                  extern XCloseDisplay
     5                                  extern XCreateSimpleWindow
     6                                  extern XMapWindow
     7                                  extern XRootWindow
     8                                  extern XSelectInput
     9                                  extern XFlush
    10                                  extern XCreateGC
    11                                  extern XSetForeground
    12                                  extern XDrawLine
    13                                  extern XNextEvent
    14                                  
    15                                  ; external functions from stdio library (ld-linux-x86-64.so.2)    
    16                                  extern printf
    17                                  extern exit
    18                                  
    19                                  extern projectVect
    20                                  extern canShow
    21                                  
    22                                  %define	StructureNotifyMask	131072
    23                                  %define KeyPressMask		1
    24                                  %define ButtonPressMask		4
    25                                  %define MapNotify		19
    26                                  %define KeyPress		2
    27                                  %define ButtonPress		4
    28                                  %define Expose			12
    29                                  %define ConfigureNotify		22
    30                                  %define CreateNotify 16
    31                                  %define QWORD	8
    32                                  %define DWORD	4
    33                                  %define WORD	2
    34                                  %define BYTE	1
    35                                  
    36                                  global main
    37                                  
    38                                  section .bss
    39 00000000 <res 00000008>          display_name:	resq	1
    40 00000008 <res 00000004>          screen:		resd	1
    41 0000000C <res 00000004>          depth:         	resd	1
    42 00000010 <res 00000004>          connection:    	resd	1
    43 00000014 <res 00000004>          width:         	resd	1
    44 00000018 <res 00000004>          height:        	resd	1
    45 0000001C <res 00000008>          window:		resq	1
    46 00000024 <res 00000008>          gc:		resq	1
    47                                  
    48                                  section .data
    49                                  
    50 00000000 0000000000000000-       event:		times	24 dq 0
    50 00000000 <rept>             
    51                                  
    52                                  ;3d coords
    53 000000C0 F6F6F6                  pt1:    db  -10,-10,-10
    54 000000C3 0AF6F6                  pt2:    db  10, -10,-10
    55 000000C6 0A0AF6                  pt3:    db  10, 10,-10
    56 000000C9 F60AF6                  pt4:    db  -10,10,-10
    57 000000CC F60A0A                  pt5:    db  -10,10,10
    58 000000CF 0A0A0A                  pt6:    db  10,10,10
    59 000000D2 0AF60A                  pt7:    db  10,-10,10
    60 000000D5 F6F60A                  pt8:    db  -10,-10,10
    61                                  
    62                                  ;2d coords projection
    63 000000D8 0000000000000000        pjpt1:  dd  0,0
    64 000000E0 0000000000000000        pjpt2:  dd  0,0
    65 000000E8 0000000000000000        pjpt3:  dd  0,0
    66 000000F0 0000000000000000        pjpt4:  dd  0,0
    67 000000F8 0000000000000000        pjpt5:  dd  0,0
    68 00000100 0000000000000000        pjpt6:  dd  0,0
    69 00000108 0000000000000000        pjpt7:  dd  0,0
    70 00000110 0000000000000000        pjpt8:  dd  0,0
    71                                  
    72                                  ; faces map
    73 00000118 00010203                face1:  db  0,1,2,3
    74 0000011C 01040702                face2:  db  1,4,7,2
    75 00000120 04050607                face3:  db  4,5,6,7
    76 00000124 05000306                face4:  db  5,0,3,6
    77 00000128 05040100                face5:  db  5,4,1,0
    78 0000012C 03020706                face6:  db  3,2,7,6
    79                                  
    80                                  ; debug message 
    81 00000130 466163652025686864-     faceMsg: db "Face %hhd",10,0
    81 00000139 0A00               
    82                                  
    83                                  ;coords buffer
    84 0000013B 00000000                x1:     dd  0
    85 0000013F 00000000                x2:     dd  0
    86 00000143 00000000                y1:     dd  0
    87 00000147 00000000                y2:     dd  0
    88                                  
    89                                  section .text
    90                                  
    91                                  ;##################################################
    92                                  ;########### PROGRAMME PRINCIPAL ##################
    93                                  ;##################################################
    94                                  
    95                                  main:
    96 00000000 4831FF                  xor     rdi,rdi
    97 00000003 E8(00000000)            call    XOpenDisplay	; Création de display
    98 00000008 48890425[00000000]      mov     qword[display_name],rax	; rax=nom du display
    99                                  
   100                                  ; display_name structure
   101                                  ; screen = DefaultScreen(display_name);
   102 00000010 488B0425[00000000]      mov     rax,qword[display_name]
   103 00000018 8B80E0000000            mov     eax,dword[rax+0xe0]
   104 0000001E 890425[08000000]        mov     dword[screen],eax
   105                                  
   106 00000025 488B3C25[00000000]      mov rdi,qword[display_name]
   107 0000002D 8B3425[08000000]        mov esi,dword[screen]
   108 00000034 E8(00000000)            call XRootWindow
   109 00000039 4889C3                  mov rbx,rax
   110                                  
   111 0000003C 488B3C25[00000000]      mov rdi,qword[display_name]
   112 00000044 4889DE                  mov rsi,rbx
   113 00000047 BA0A000000              mov rdx,10
   114 0000004C B90A000000              mov rcx,10
   115 00000051 41B890010000            mov r8,400	; largeur
   116 00000057 41B990010000            mov r9,400	; hauteur
   117 0000005D 6A00                    push 0x000000	; background  0xRRGGBB
   118 0000005F 6800FF0000              push 0x00FF00
   119 00000064 6A01                    push 1
   120 00000066 E8(00000000)            call XCreateSimpleWindow
   121 0000006B 48890425[1C000000]      mov qword[window],rax
   122                                  
   123 00000073 488B3C25[00000000]      mov rdi,qword[display_name]
   124 0000007B 488B3425[1C000000]      mov rsi,qword[window]
   125 00000083 BA05000200              mov rdx,131077 ;131072
   126 00000088 E8(00000000)            call XSelectInput
   127                                  
   128 0000008D 488B3C25[00000000]      mov rdi,qword[display_name]
   129 00000095 488B3425[1C000000]      mov rsi,qword[window]
   130 0000009D E8(00000000)            call XMapWindow
   131                                  
   132 000000A2 488B3425[1C000000]      mov rsi,qword[window]
   133 000000AA BA00000000              mov rdx,0
   134 000000AF B900000000              mov rcx,0
   135 000000B4 E8(00000000)            call XCreateGC
   136 000000B9 48890425[24000000]      mov qword[gc],rax
   137                                  
   138 000000C1 488B3C25[00000000]      mov rdi,qword[display_name]
   139 000000C9 488B3425[24000000]      mov rsi,qword[gc]
   140 000000D1 BAFFFFFF00              mov rdx,0xFFFFFF	; Couleur du crayon
   141 000000D6 E8(00000000)            call XSetForeground
   142                                  
   143                                  boucle: ; boucle de gestion des évènements
   144 000000DB 488B3C25[00000000]      mov rdi,qword[display_name]
   145 000000E3 48BE-                   mov rsi,event
   145 000000E5 [0000000000000000] 
   146 000000ED E8(00000000)            call XNextEvent
   147                                  
   148 000000F2 833C25[00000000]16      cmp dword[event],ConfigureNotify	; à l'apparition de la fenêtre
   149 000000FA 7410                    je dessin							; on saute au label 'dessin'
   150                                  
   151 000000FC 833C25[00000000]02      cmp dword[event],KeyPress			; Si on appuie sur une touche
   152 00000104 0F844E030000            je closeDisplay						; on saute au label 'closeDisplay' qui ferme la fenêtre
   153 0000010A EBCF                    jmp boucle
   154                                  
   155                                  ;#########################################
   156                                  ;#		DEBUT DE LA ZONE DE DESSIN		 #
   157                                  ;#########################################
   158                                  dessin:
   159                                  
   160 0000010C B100                    mov cl,0 ; compteur à zero
   161                                  
   162                                  forpts: ; boucle for
   163                                  
   164                                   ;passation du paramètre des points 3D
   165 0000010E 48BB-                    mov rbx,pt1 
   165 00000110 [C000000000000000] 
   166 00000118 4831C0                   xor rax,rax
   167 0000011B B003                     mov al,3
   168 0000011D F6E1                     mul cl
   169 0000011F 4801C3                   add rbx,rax
   170 00000122 4889DF                   mov rdi, rbx
   171                                   
   172                                   ;passation du paramètre des points 2D
   173 00000125 48BB-                    mov rbx,pjpt1
   173 00000127 [D800000000000000] 
   174 0000012F 4831C0                   xor rax,rax
   175 00000132 B008                     mov al,8
   176 00000134 F6E1                     mul cl
   177 00000136 4801C3                   add rbx,rax
   178 00000139 4889DE                   mov rsi, rbx
   179                                   
   180                                   ;Appel de la fonction:
   181                                   ; projectVect(vec3 rdi,vec2 rsi)
   182 0000013C E8(00000000)             call projectVect
   183 00000141 FEC1                     inc cl
   184 00000143 80F908                   cmp cl,8 ; 8 iérations = nb sommets
   185 00000146 72C6                     jb forpts
   186                                   
   187 00000148 B100                    mov cl,0 ; compteur à zero
   188                                  forfaces:
   189 0000014A 48BB-                    mov rbx,face1
   189 0000014C [1801000000000000] 
   190 00000154 B804000000               mov rax,4
   191 00000159 F6E1                     mul cl
   192 0000015B 4801C3                   add rbx,rax ; rbx = adresse face itérée
   193                                   
   194 0000015E 51                       push rcx
   195                                   
   196 0000015F 48B9-                    mov rcx, pjpt1
   196 00000161 [D800000000000000] 
   197 00000169 B408                     mov ah,8
   198 0000016B 8A03                     mov al, [rbx]
   199 0000016D F6E4                     mul ah
   200 0000016F 4801C1                   add rcx, rax
   201 00000172 4889CF                   mov rdi,rcx  ; vector-pos 1
   202                                  
   203 00000175 48B9-                    mov rcx, pjpt1
   203 00000177 [D800000000000000] 
   204 0000017F B408                     mov ah,8
   205 00000181 8A4301                   mov al, [rbx+1]
   206 00000184 F6E4                     mul ah
   207 00000186 4801C1                   add rcx, rax
   208 00000189 4889CE                   mov rsi,rcx ; vecteur position 2
   209                                   
   210 0000018C 48B9-                    mov rcx, pjpt1
   210 0000018E [D800000000000000] 
   211 00000196 B408                     mov ah,8
   212 00000198 8A4303                   mov al, [rbx+3]
   213 0000019B F6E4                     mul ah
   214 0000019D 4801C1                   add rcx, rax
   215 000001A0 4889CA                   mov rdx,rcx ; vecteur position 3
   216                                   
   217                                   ;Appel de la fonction de face
   218                                   ;canShow(vec2 rdi, vec2 rsi, vec rdx) 
   219 000001A3 E8(00000000)             call canShow
   220                                   
   221 000001A8 59                       pop rcx
   222                                   
   223 000001A9 4883F801                 cmp rax,1
   224 000001AD 0F857F020000             jne endforfaces
   225                                      
   226 000001B3 51                       push rcx ; empilement de rcx
   227                                  
   228 000001B4 48BF-                     mov rdi, faceMsg
   228 000001B6 [3001000000000000] 
   229 000001BE 4889CE                    mov rsi, rcx
   230 000001C1 B800000000                mov rax,0
   231 000001C6 E8(00000000)              call printf
   232                                  
   233                                   
   234 000001CB B800000000                mov rax,0
   235 000001D0 48B9-                     mov rcx,pjpt1
   235 000001D2 [D800000000000000] 
   236 000001DA B008                      mov al, 8
   237 000001DC 8A23                      mov ah, [rbx]
   238 000001DE F6E4                      mul ah
   239 000001E0 4801C1                    add rcx, rax
   240 000001E3 4889C8                    mov rax, rcx
   241 000001E6 8B08                      mov ecx, [rax]
   242 000001E8 890C25[3B010000]          mov [x1],ecx
   243 000001EF 8B4804                    mov ecx, [rax+4]
   244 000001F2 890C25[43010000]          mov [y1],ecx
   245                                   
   246 000001F9 B800000000                mov rax,0
   247 000001FE 48B9-                     mov rcx,pjpt1
   247 00000200 [D800000000000000] 
   248 00000208 B008                      mov al, 8
   249 0000020A 8A6301                    mov ah, [rbx+1]
   250 0000020D F6E4                      mul ah
   251 0000020F 4801C1                    add rcx, rax
   252 00000212 4889C8                    mov rax, rcx
   253 00000215 8B08                      mov ecx, [rax]
   254 00000217 890C25[3F010000]          mov [x2],ecx
   255 0000021E 8B4804                    mov ecx, [rax+4]
   256 00000221 890C25[47010000]          mov [y2],ecx
   257                                   
   258 00000228 488B3C25[00000000]        mov rdi,qword[display_name]
   259 00000230 488B3425[1C000000]        mov rsi,qword[window]
   260 00000238 488B1425[24000000]        mov rdx,qword[gc]
   261 00000240 8B0C25[3B010000]          mov ecx,dword[x1]	; coordonnée source en x
   262 00000247 448B0425[43010000]        mov r8d,dword[y1]	; coordonnée source en y
   263 0000024F 448B0C25[3F010000]        mov r9d,dword[x2]	; coordonnée destination en x
   264 00000257 FF3425[47010000]          push qword[y2]		; coordonnée destination en y
   265 0000025E E8(00000000)              call XDrawLine
   266 00000263 59                        pop rcx
   267                                   
   268 00000264 B800000000                mov rax,0
   269 00000269 48B9-                     mov rcx,pjpt1
   269 0000026B [D800000000000000] 
   270 00000273 B008                      mov al, 8
   271 00000275 8A6301                    mov ah, [rbx+1]
   272 00000278 F6E4                      mul ah
   273 0000027A 4801C1                    add rcx, rax
   274 0000027D 4889C8                    mov rax, rcx
   275 00000280 8B08                      mov ecx, [rax]
   276 00000282 890C25[3B010000]          mov [x1],ecx
   277 00000289 8B4804                    mov ecx, [rax+4]
   278 0000028C 890C25[43010000]          mov [y1],ecx
   279                                   
   280 00000293 B800000000                mov rax,0
   281 00000298 48B9-                     mov rcx,pjpt1
   281 0000029A [D800000000000000] 
   282 000002A2 B008                      mov al, 8
   283 000002A4 8A6302                    mov ah, [rbx+2]
   284 000002A7 F6E4                      mul ah
   285 000002A9 4801C1                    add rcx, rax
   286 000002AC 4889C8                    mov rax, rcx
   287 000002AF 8B08                      mov ecx, [rax]
   288 000002B1 890C25[3F010000]          mov [x2],ecx
   289 000002B8 8B4804                    mov ecx, [rax+4]
   290 000002BB 890C25[47010000]          mov [y2],ecx
   291                                   
   292 000002C2 488B3C25[00000000]        mov rdi,qword[display_name]
   293 000002CA 488B3425[1C000000]        mov rsi,qword[window]
   294 000002D2 488B1425[24000000]        mov rdx,qword[gc]
   295 000002DA 8B0C25[3B010000]          mov ecx,dword[x1]	; coordonnée source en x
   296 000002E1 448B0425[43010000]        mov r8d,dword[y1]	; coordonnée source en y
   297 000002E9 448B0C25[3F010000]        mov r9d,dword[x2]	; coordonnée destination en x
   298 000002F1 FF3425[47010000]          push qword[y2]		; coordonnée destination en y
   299 000002F8 E8(00000000)              call XDrawLine
   300 000002FD 59                        pop rcx
   301                                    
   302 000002FE B800000000                mov rax,0
   303 00000303 48B9-                     mov rcx,pjpt1
   303 00000305 [D800000000000000] 
   304 0000030D B008                      mov al, 8
   305 0000030F 8A6302                    mov ah, [rbx+2]
   306 00000312 F6E4                      mul ah
   307 00000314 4801C1                    add rcx, rax
   308 00000317 4889C8                    mov rax, rcx
   309 0000031A 8B08                      mov ecx, [rax]
   310 0000031C 890C25[3B010000]          mov [x1],ecx
   311 00000323 8B4804                    mov ecx, [rax+4]
   312 00000326 890C25[43010000]          mov [y1],ecx
   313                                   
   314 0000032D B800000000                mov rax,0
   315 00000332 48B9-                     mov rcx,pjpt1
   315 00000334 [D800000000000000] 
   316 0000033C B008                      mov al, 8
   317 0000033E 8A6303                    mov ah, [rbx+3]
   318 00000341 F6E4                      mul ah
   319 00000343 4801C1                    add rcx, rax
   320 00000346 4889C8                    mov rax, rcx
   321 00000349 8B08                      mov ecx, [rax]
   322 0000034B 890C25[3F010000]          mov [x2],ecx
   323 00000352 8B4804                    mov ecx, [rax+4]
   324 00000355 890C25[47010000]          mov [y2],ecx
   325                                   
   326 0000035C 488B3C25[00000000]        mov rdi,qword[display_name]
   327 00000364 488B3425[1C000000]        mov rsi,qword[window]
   328 0000036C 488B1425[24000000]        mov rdx,qword[gc]
   329 00000374 8B0C25[3B010000]          mov ecx,dword[x1]	; coordonnée source en x
   330 0000037B 448B0425[43010000]        mov r8d,dword[y1]	; coordonnée source en y
   331 00000383 448B0C25[3F010000]        mov r9d,dword[x2]	; coordonnée destination en x
   332 0000038B FF3425[47010000]          push qword[y2]		; coordonnée destination en y
   333 00000392 E8(00000000)              call XDrawLine
   334 00000397 59                        pop rcx
   335                                    
   336 00000398 B800000000                mov rax,0
   337 0000039D 48B9-                     mov rcx,pjpt1
   337 0000039F [D800000000000000] 
   338 000003A7 B008                      mov al, 8
   339 000003A9 8A6303                    mov ah, [rbx+3]
   340 000003AC F6E4                      mul ah
   341 000003AE 4801C1                    add rcx, rax
   342 000003B1 4889C8                    mov rax, rcx
   343 000003B4 8B08                      mov ecx, [rax]
   344 000003B6 890C25[3B010000]          mov [x1],ecx
   345 000003BD 8B4804                    mov ecx, [rax+4]
   346 000003C0 890C25[43010000]          mov [y1],ecx
   347                                   
   348 000003C7 B800000000                mov rax,0
   349 000003CC 48B9-                     mov rcx,pjpt1
   349 000003CE [D800000000000000] 
   350 000003D6 B008                      mov al, 8
   351 000003D8 8A23                      mov ah, [rbx]
   352 000003DA F6E4                      mul ah
   353 000003DC 4801C1                    add rcx, rax
   354 000003DF 4889C8                    mov rax, rcx
   355 000003E2 8B08                      mov ecx, [rax]
   356 000003E4 890C25[3F010000]          mov [x2],ecx
   357 000003EB 8B4804                    mov ecx, [rax+4]
   358 000003EE 890C25[47010000]          mov [y2],ecx
   359                                   
   360 000003F5 488B3C25[00000000]        mov rdi,qword[display_name]
   361 000003FD 488B3425[1C000000]        mov rsi,qword[window]
   362 00000405 488B1425[24000000]        mov rdx,qword[gc]
   363 0000040D 8B0C25[3B010000]          mov ecx,dword[x1]	; coordonnée source en x
   364 00000414 448B0425[43010000]        mov r8d,dword[y1]	; coordonnée source en y
   365 0000041C 448B0C25[3F010000]        mov r9d,dword[x2]	; coordonnée destination en x
   366 00000424 FF3425[47010000]          push qword[y2]		; coordonnée destination en y
   367 0000042B E8(00000000)              call XDrawLine
   368 00000430 59                        pop rcx
   369                                    
   370 00000431 59                        pop rcx
   371                                   
   372                                   endforfaces:
   373                                   
   374                                   
   375 00000432 FEC1                     inc cl
   376 00000434 80F906                   cmp cl, 6
   377 00000437 0F820DFDFFFF             jb forfaces
   378                                  
   379                                  
   380                                  
   381                                  ; ############################
   382                                  ; # FIN DE LA ZONE DE DESSIN #
   383                                  ; ############################
   384 0000043D EB00                    jmp flush
   385                                  
   386                                  flush:
   387 0000043F 488B3C25[00000000]      mov rdi,qword[display_name]
   388 00000447 E8(00000000)            call XFlush
   389 0000044C E98AFCFFFF              jmp boucle
   390 00000451 B822000000              mov rax,34
   391 00000456 0F05                    syscall
   392                                  
   393                                  closeDisplay:
   394 00000458 488B0425[00000000]          mov     rax,qword[display_name]
   395 00000460 4889C7                      mov     rdi,rax
   396 00000463 E8(00000000)                call    XCloseDisplay
   397 00000468 4831FF                      xor	    rdi,rdi
   398 0000046B E8(00000000)                call    exit
   399                                  	
